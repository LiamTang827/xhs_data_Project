# æ–°åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚æ¦‚è§ˆ

### 1. å®šæ—¶çˆ¬å–åŠŸèƒ½
è‡ªåŠ¨å®šæœŸæ›´æ–°å·²å…³æ³¨åˆ›ä½œè€…çš„æœ€æ–°ç¬”è®°

### 2. çƒ­ç‚¹è¯é¢˜åˆ†æ
åˆ†ææ‰€æœ‰åˆ›ä½œè€…çš„ç¬”è®°ï¼Œæå–çƒ­é—¨è¯é¢˜å’Œè¶‹åŠ¿

### 3. å‰ç«¯æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½
ç”¨æˆ·å¯ä»¥è¾“å…¥å°çº¢ä¹¦ç”¨æˆ·IDï¼Œç³»ç»Ÿè‡ªåŠ¨çˆ¬å–å¹¶åˆ†æ

---

## ğŸ—ï¸ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå®šæ—¶çˆ¬å–åŠŸèƒ½

#### åç«¯å®ç°
**æ–‡ä»¶ï¼š`backend/tasks/scheduler.py`**
```python
#!/usr/bin/env python3
"""
å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ - è‡ªåŠ¨æ›´æ–°åˆ›ä½œè€…æ•°æ®
"""
import asyncio
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import datetime

class DataUpdateScheduler:
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
    
    async def update_all_creators(self):
        """æ›´æ–°æ‰€æœ‰åˆ›ä½œè€…çš„æœ€æ–°ç¬”è®°"""
        # 1. è·å–æ‰€æœ‰åˆ›ä½œè€…åˆ—è¡¨
        # 2. å¯¹æ¯ä¸ªåˆ›ä½œè€…è°ƒç”¨collector
        # 3. è¿è¡Œpipelineåˆ†æ
        pass
    
    def start(self):
        # æ¯å¤©å‡Œæ™¨2ç‚¹æ›´æ–°
        self.scheduler.add_job(
            self.update_all_creators,
            'cron',
            hour=2,
            minute=0
        )
        self.scheduler.start()
```

**é…ç½®é€‰é¡¹ï¼š**
- âœ… æ¯æ—¥æ›´æ–°ï¼šé€‚åˆçƒ­é—¨åˆ›ä½œè€…
- âœ… æ¯å‘¨æ›´æ–°ï¼šé€‚åˆæ™®é€šåˆ›ä½œè€…
- âœ… æ‰‹åŠ¨è§¦å‘ï¼šç«‹å³æ›´æ–°æŒ‡å®šåˆ›ä½œè€…

---

### æ–¹æ¡ˆ2ï¼šçƒ­ç‚¹è¯é¢˜åˆ†æ

#### åç«¯API
**æ–‡ä»¶ï¼š`backend/api/routers/trending_router.py`**
```python
@router.get("/topics")
async def get_trending_topics(
    days: int = 7,  # åˆ†ææœ€è¿‘Nå¤©
    limit: int = 10  # è¿”å›å‰Nä¸ªè¯é¢˜
):
    """
    è·å–çƒ­ç‚¹è¯é¢˜
    
    æµç¨‹ï¼š
    1. ä»MongoDBè·å–æœ€è¿‘Nå¤©çš„æ‰€æœ‰ç¬”è®°
    2. æå–è¯é¢˜æ ‡ç­¾å’Œå…³é”®è¯
    3. ç»Ÿè®¡é¢‘ç‡å’Œçƒ­åº¦
    4. è¿”å›æ’åºåçš„çƒ­ç‚¹è¯é¢˜
    """
    pass

@router.get("/trends")
async def get_content_trends(
    topic: str = None  # å¯é€‰ï¼šæŒ‡å®šè¯é¢˜
):
    """
    è·å–å†…å®¹è¶‹åŠ¿
    
    åˆ†æç»´åº¦ï¼š
    - å‘å¸ƒé¢‘ç‡è¶‹åŠ¿
    - äº’åŠ¨é‡è¶‹åŠ¿
    - çƒ­é—¨åˆ›ä½œè€…
    - æ–°å…´è¯é¢˜
    """
    pass
```

#### å‰ç«¯å±•ç¤º
**æ–‡ä»¶ï¼š`xhs-analyser-frontend/src/components/TrendingTopics.tsx`**
```typescript
// å·²å­˜åœ¨ï¼Œéœ€è¦è¿æ¥åˆ°æ–°çš„API
- çƒ­ç‚¹è¯é¢˜äº‘
- è¯é¢˜è¶‹åŠ¿å›¾è¡¨
- åˆ›ä½œè€…æ’è¡Œ
```

---

### æ–¹æ¡ˆ3ï¼šæ·»åŠ åˆ›ä½œè€…åŠŸèƒ½

#### åç«¯API
**æ–‡ä»¶ï¼š`backend/api/routers/creator_router.py`**
```python
@router.post("/creators/add")
async def add_creator(request: AddCreatorRequest):
    """
    æ·»åŠ æ–°åˆ›ä½œè€…
    
    Args:
        user_id: å°çº¢ä¹¦ç”¨æˆ·ID (å¿…éœ€)
        auto_update: æ˜¯å¦åŠ å…¥å®šæ—¶æ›´æ–° (å¯é€‰ï¼Œé»˜è®¤true)
    
    æµç¨‹ï¼š
    1. éªŒè¯user_idæ ¼å¼
    2. è°ƒç”¨collectorçˆ¬å–æ•°æ®
    3. è°ƒç”¨pipelineåˆ†æ
    4. ä¿å­˜åˆ°æ•°æ®åº“
    5. è¿”å›åˆ›ä½œè€…ä¿¡æ¯
    
    è¿”å›ï¼š
        {
            "success": true,
            "creator": {...},
            "message": "åˆ›ä½œè€…æ·»åŠ æˆåŠŸ"
        }
    """
    pass

@router.post("/creators/{user_id}/refresh")
async def refresh_creator_data(user_id: str):
    """æ‰‹åŠ¨åˆ·æ–°åˆ›ä½œè€…æ•°æ®"""
    pass

@router.delete("/creators/{user_id}")
async def remove_creator(user_id: str):
    """ç§»é™¤åˆ›ä½œè€…ï¼ˆè½¯åˆ é™¤ï¼‰"""
    pass
```

#### å‰ç«¯é¡µé¢
**æ–‡ä»¶ï¼š`xhs-analyser-frontend/src/components/AddCreatorDialog.tsx`**
```typescript
// æ–°ç»„ä»¶ï¼šæ·»åŠ åˆ›ä½œè€…å¯¹è¯æ¡†
åŠŸèƒ½ï¼š
- è¾“å…¥æ¡†ï¼šå°çº¢ä¹¦ç”¨æˆ·ID
- éªŒè¯ï¼šæ£€æŸ¥IDæ ¼å¼
- è¿›åº¦ï¼šæ˜¾ç¤ºçˆ¬å–è¿›åº¦ï¼ˆçˆ¬å– â†’ åˆ†æ â†’ å®Œæˆï¼‰
- é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºå¤±è´¥åŸå› 
```

**é›†æˆä½ç½®ï¼š**
- åˆ›ä½œè€…åˆ—è¡¨é¡µé¢æ·»åŠ "+" æŒ‰é’®
- ç‚¹å‡»æ‰“å¼€å¯¹è¯æ¡†
- è¾“å…¥IDåå¼€å§‹å¤„ç†
- æ˜¾ç¤ºå®æ—¶è¿›åº¦

---

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. âœ… **æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½** - æœ€å®ç”¨
   - åç«¯APIï¼š1-2å°æ—¶
   - å‰ç«¯UIï¼š2-3å°æ—¶
   - æµ‹è¯•ï¼š1å°æ—¶

### ç¬¬äºŒé˜¶æ®µï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
2. âœ… **çƒ­ç‚¹è¯é¢˜åˆ†æ** - æœ‰ä»·å€¼
   - æ•°æ®èšåˆï¼š2å°æ—¶
   - APIå¼€å‘ï¼š1-2å°æ—¶
   - å‰ç«¯å±•ç¤ºï¼š2å°æ—¶

### ç¬¬ä¸‰é˜¶æ®µï¼ˆä½ä¼˜å…ˆçº§ï¼‰
3. âœ… **å®šæ—¶çˆ¬å–** - å¯ä»¥åæœŸä¼˜åŒ–
   - è°ƒåº¦å™¨ï¼š1å°æ—¶
   - ä»»åŠ¡ç®¡ç†ï¼š2å°æ—¶
   - ç›‘æ§æ—¥å¿—ï¼š1å°æ—¶

---

## ğŸ’¡ æŠ€æœ¯é€‰å‹

### å®šæ—¶ä»»åŠ¡
```python
# æ¨èï¼šAPScheduler
pip install apscheduler

# ä¼˜ç‚¹ï¼š
- æ”¯æŒå¤šç§è§¦å‘å™¨ï¼ˆcronã€intervalã€dateï¼‰
- å¯æŒä¹…åŒ–åˆ°æ•°æ®åº“
- æ”¯æŒå¼‚æ­¥ä»»åŠ¡
```

### è¿›åº¦è¿½è¸ª
```python
# ä½¿ç”¨MongoDBè®°å½•ä»»åŠ¡çŠ¶æ€
collection: task_logs
{
    "task_id": "add_creator_xxx",
    "user_id": "5e647...",
    "status": "running|success|failed",
    "progress": {
        "current": "analyzing",  # fetching|analyzing|saving
        "percent": 60
    },
    "created_at": "2026-02-03T10:00:00",
    "finished_at": null,
    "error": null
}
```

### WebSocketå®æ—¶æ›´æ–°ï¼ˆå¯é€‰ï¼‰
```python
# å¦‚æœéœ€è¦å®æ—¶è¿›åº¦æ›´æ–°
from fastapi import WebSocket

@app.websocket("/ws/task/{task_id}")
async def task_progress(websocket: WebSocket, task_id: str):
    # å®æ—¶æ¨é€ä»»åŠ¡è¿›åº¦
    pass
```

---

## ğŸ“ æ•°æ®åº“Schemaæ‰©å±•

### æ–°å¢é›†åˆï¼štask_logs
```javascript
{
    task_id: String,          // ä»»åŠ¡å”¯ä¸€ID
    task_type: String,        // "add_creator" | "refresh_creator" | "auto_update"
    user_id: String,          // ç›®æ ‡ç”¨æˆ·ID
    status: String,           // "pending" | "running" | "success" | "failed"
    progress: Object,         // è¿›åº¦ä¿¡æ¯
    result: Object,           // ç»“æœæ•°æ®
    error: String,            // é”™è¯¯ä¿¡æ¯
    created_at: Date,
    updated_at: Date,
    finished_at: Date
}
```

### æ‰©å±•user_profiles
```javascript
{
    // åŸæœ‰å­—æ®µ...
    
    // æ–°å¢å­—æ®µ
    auto_update: Boolean,     // æ˜¯å¦è‡ªåŠ¨æ›´æ–°
    update_frequency: String, // "daily" | "weekly" | "manual"
    last_updated: Date,       // æœ€åæ›´æ–°æ—¶é—´
    next_update: Date,        // ä¸‹æ¬¡æ›´æ–°æ—¶é—´
    update_error: String,     // æ›´æ–°é”™è¯¯
    is_active: Boolean        // æ˜¯å¦æ´»è·ƒï¼ˆç”¨äºè½¯åˆ é™¤ï¼‰
}
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶

### backend/core/config.py
```python
class Settings(BaseSettings):
    # åŸæœ‰é…ç½®...
    
    # æ–°å¢ï¼šå®šæ—¶ä»»åŠ¡é…ç½®
    ENABLE_AUTO_UPDATE: bool = True
    UPDATE_HOUR: int = 2  # å‡Œæ™¨2ç‚¹
    UPDATE_MINUTE: int = 0
    
    # æ–°å¢ï¼šçˆ¬å–é™åˆ¶
    MAX_NOTES_PER_USER: int = 100
    COLLECTOR_TIMEOUT: int = 300  # 5åˆ†é’Ÿè¶…æ—¶
    
    # æ–°å¢ï¼šçƒ­ç‚¹åˆ†æé…ç½®
    TRENDING_DAYS: int = 7  # åˆ†ææœ€è¿‘7å¤©
    TRENDING_MIN_NOTES: int = 5  # è‡³å°‘5ç¯‡ç¬”è®°æ‰ç®—çƒ­ç‚¹
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æˆ‘ç°åœ¨åº”è¯¥åšä»€ä¹ˆï¼Ÿ

**æ¨èï¼šå…ˆå®ç°"æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½"**

åŸå› ï¼š
- âœ… æœ€å®ç”¨ï¼Œç”¨æˆ·ç›´æ¥å—ç›Š
- âœ… å®ç°ç®€å•ï¼Œé£é™©ä½
- âœ… ä¸ºåç»­åŠŸèƒ½æ‰“åŸºç¡€

### 2. éœ€è¦æˆ‘ç«‹å³å¼€å§‹ç¼–ç å—ï¼Ÿ

**è¯·å…ˆç¡®è®¤ä»¥ä¸‹é—®é¢˜ï¼š**

1. **æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½**
   - âœ… ç”¨æˆ·è¾“å…¥çš„æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Ÿï¼ˆç”¨æˆ·IDè¿˜æ˜¯ä¸»é¡µé“¾æ¥ï¼Ÿï¼‰
   - âœ… æ˜¯å¦éœ€è¦éªŒè¯ç”¨æˆ·å­˜åœ¨æ€§ï¼Ÿ
   - âœ… æ·»åŠ åæ˜¯å¦ç«‹å³å¯ç”¨äºç”Ÿæˆæ–‡æ¡ˆï¼Ÿ
   - âœ… æ˜¯å¦éœ€è¦æ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼Ÿ

2. **å®šæ—¶çˆ¬å–**
   - âœ… å¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿï¼ˆæ¯å¤©ï¼Ÿæ¯å‘¨ï¼Ÿï¼‰
   - âœ… æ˜¯å¦éœ€è¦åå°ä»»åŠ¡ç®¡ç†ç•Œé¢ï¼Ÿ
   - âœ… å¤±è´¥æ—¶å¦‚ä½•é€šçŸ¥ï¼Ÿ

3. **çƒ­ç‚¹è¯é¢˜**
   - âœ… éœ€è¦å“ªäº›ç»´åº¦çš„åˆ†æï¼Ÿ
   - âœ… å‰ç«¯å¦‚ä½•å±•ç¤ºï¼ˆå›¾è¡¨ï¼Ÿåˆ—è¡¨ï¼Ÿè¯äº‘ï¼Ÿï¼‰
   - âœ… æ˜¯å¦éœ€è¦è¯é¢˜è¯¦æƒ…é¡µï¼Ÿ

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### å¼€å‘æ—¶é—´
- æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½ï¼š**4-6å°æ—¶**
- çƒ­ç‚¹è¯é¢˜åˆ†æï¼š**5-7å°æ—¶**
- å®šæ—¶çˆ¬å–åŠŸèƒ½ï¼š**4-5å°æ—¶**

**æ€»è®¡ï¼š13-18å°æ—¶**ï¼ˆ1-2ä¸ªå·¥ä½œæ—¥ï¼‰

### APIè°ƒç”¨æˆæœ¬
- æ¯æ·»åŠ 1ä¸ªåˆ›ä½œè€…ï¼š~5000 tokensï¼ˆåˆ†æï¼‰
- æ¯æ¬¡å®šæ—¶æ›´æ–°ï¼š~2000 tokens/åˆ›ä½œè€…
- çƒ­ç‚¹åˆ†æï¼šå¯ä»¥ä¸è°ƒç”¨AIï¼Œçº¯æ•°æ®ç»Ÿè®¡

---

## âœ… ä¸‹ä¸€æ­¥

è¯·å‘Šè¯‰æˆ‘ï¼š
1. æ˜¯å¦åŒæ„è¿™ä¸ªæ–¹æ¡ˆï¼Ÿ
2. æƒ³ä»å“ªä¸ªåŠŸèƒ½å¼€å§‹ï¼Ÿ
3. æœ‰ä»€ä¹ˆç‰¹æ®Šéœ€æ±‚éœ€è¦è°ƒæ•´ï¼Ÿ

**æˆ‘å»ºè®®ï¼šå…ˆå®ç°"æ·»åŠ åˆ›ä½œè€…åŠŸèƒ½"ï¼Œè®©ç³»ç»Ÿå¯ç”¨èµ·æ¥ï¼**
