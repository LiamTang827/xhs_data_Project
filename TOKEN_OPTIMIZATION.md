# Token使用优化方案

## 当前问题
每次生成文案都发送：
- 创作者档案（完整）
- 5篇笔记样本（完整全文）
- 提示词模板
- 用户输入

导致单次消耗3000-10000 tokens

## 优化方案（按效果排序）

### 方案1：启用缓存（已实现，但需配置）⭐⭐⭐⭐⭐
**效果：减少90%输入token成本**

当前代码已支持缓存，但需要：
1. 检查LLM Gateway缓存是否生效
2. 对于同一创作者，档案+笔记会被缓存
3. 只需为新的用户输入付费

**适用场景：**
- 同一创作者生成多次
- 不同用户使用同一创作者

### 方案2：压缩笔记内容 ⭐⭐⭐⭐
**效果：减少50-70%输入token**

```python
def compress_notes(notes, max_chars=500):
    """只保留笔记的前N个字，而不是全文"""
    compressed = []
    for note in notes:
        title = note.get('title', '')
        desc = note.get('desc', '')[:max_chars]  # 只取前500字
        compressed.append({'title': title, 'desc': desc})
    return compressed
```

**建议配置：**
- 每篇笔记只取前300-500字
- 保留最有特色的开头部分

### 方案3：减少笔记数量 ⭐⭐⭐
**效果：减少40-60%输入token**

```python
# 当前：加载5篇笔记
sample_notes = self.load_creator_notes(creator_name, platform, limit=5)

# 优化：只加载3篇
sample_notes = self.load_creator_notes(creator_name, platform, limit=3)
```

**适用场景：**
- 创作者风格明显
- 对风格准确度要求不高

### 方案4：智能选择笔记 ⭐⭐⭐⭐
**效果：提升质量，减少token**

不是随机选5篇，而是：
- 选择最受欢迎的笔记（点赞/评论最多）
- 选择与用户主题最相关的笔记
- 选择最能代表风格的笔记

### 方案5：提取风格摘要（高级）⭐⭐⭐⭐⭐
**效果：减少70-90%输入token**

**原理：**
一次性分析创作者所有笔记，提取风格摘要（500-1000字），保存到数据库。
以后生成时只发送摘要，不发送原始笔记。

**实现步骤：**
1. 离线分析：为每个创作者生成一次风格摘要
2. 保存摘要到 `user_profiles` 的 `style_summary` 字段
3. 生成时使用摘要替代原始笔记

**成本：**
- 初始分析：每个创作者消耗5000-10000 tokens（一次性）
- 后续生成：每次只消耗500-1000 tokens（节省80%）

### 方案6：使用更便宜的模型 ⭐⭐
**效果：降低成本，但可能影响质量**

- deepseek-chat：输入$0.27/M, 输出$1.1/M
- deepseek-reasoner：输入$0.55/M, 输出$2.19/M（贵2倍）

**检查是否误用了reasoner模型**

## 推荐组合方案

### 快速优化（立即实施）
1. ✅ 确认缓存已启用
2. ✅ 减少笔记数量：5篇 → 3篇
3. ✅ 压缩笔记内容：每篇只取前400字

**预期效果：**
- 单次消耗：10000 → 3000 tokens（减少70%）
- 6650次调用：66M → 20M tokens
- 成本：从$35 → $10（节省$25）

### 长期优化（值得投入）
1. 实现风格摘要系统
2. 智能选择笔记
3. 完善缓存策略

**预期效果：**
- 单次消耗：10000 → 1500 tokens（减少85%）
- 成本降低到原来的15%

## 立即行动建议

1. **先检查缓存是否生效**（最重要）
   ```python
   # 在 llm_gateway.py 中添加日志
   print(f"🔍 Cache hit: {cached}")
   ```

2. **实施笔记压缩**（最容易）
   - 修改 `load_creator_notes` 方法
   - 每篇笔记只取前400字

3. **监控使用量**
   - 记录每次生成的实际token数
   - 分析哪些创作者消耗最多

## 成本对比（假设6650次调用）

| 方案 | 输入Tokens | 输出Tokens | 总成本 | 节省 |
|------|-----------|-----------|--------|------|
| 当前 | 50M | 15M | ~$30 | - |
| +缓存 | 5M | 15M | ~$18 | 40% |
| +压缩笔记 | 3M | 15M | ~$17 | 43% |
| +减少数量 | 2M | 15M | ~$17 | 43% |
| +风格摘要 | 1M | 15M | ~$17 | 43% |
| 全部优化 | 1M | 15M | ~$17 | 43% |

**注意：** 如果使用了deepseek-reasoner，成本会翻倍！检查代码确保使用deepseek-chat。
