# å°çº¢ä¹¦æ•°æ®é‡‡é›†ç³»ç»Ÿ - æ•°æ®ç»“æ„è®¾è®¡æ–‡æ¡£

## ğŸ“Š æ•°æ®æºåˆ†æ

### 1. TikHub API - get_user_notes_v2
**ç”¨é€”**: è·å–ç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°
**è¿”å›ç»“æ„**:
```json
{
  "notes": [
    {
      "id": "ç¬”è®°ID",
      "title": "æ ‡é¢˜",
      "desc": "æè¿°",
      "likes": 123,
      "collected_count": 45,
      "comments_count": 67,
      "share_count": 8,
      "user": {
        "nickname": "æ˜µç§°",
        "userid": "5ff98b9d0000000001008f40",
        "images": "å¤´åƒURL"
      }
    }
  ]
}
```
**é™åˆ¶**: 
- user.fansç»å¸¸ä¸ºnull
- ä½†æœ‰å®Œæ•´çš„ç¬”è®°äº’åŠ¨æ•°æ®

### 2. TikHub API - fetch_user_info_app (æ–°)
**ç”¨é€”**: è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
**è¿”å›ç»“æ„**:
```json
{
  "userid": "5ff98b9d0000000001008f40",
  "nickname": "æ˜Ÿçƒç ”ç©¶æ‰€InstituteforPlanet",
  "red_id": "9421098264",
  "desc": "ç®€ä»‹",
  "images": "å¤´åƒURL",
  "fans": 1087876,  // âœ… ç²‰ä¸æ•°
  "follows": 40,
  "liked": 2779558,  // è·èµæ€»æ•°
  "collected": 881366,  // è¢«æ”¶è—æ€»æ•°
  "ip_location": "åŒ—äº¬",
  "gender": 2,
  "tags": ["æ ‡ç­¾"]
}
```
**ä¼˜åŠ¿**: 
- âœ… æœ‰çœŸå®ç²‰ä¸æ•°
- âœ… æœ‰å®Œæ•´ç”¨æˆ·èµ„æ–™
- âœ… user_idå¯ä»¥å…³è”

---

## ğŸ—„ï¸ ä¼˜åŒ–åçš„æ•°æ®åº“è®¾è®¡

### Collection 1: user_snapshots (ä¿æŒä¸å˜)
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·çš„ç¬”è®°å¿«ç…§æ•°æ®
**æ¥æº**: TikHub get_user_notes_v2
**ç»“æ„**:
```javascript
{
  "_id": ObjectId,
  "platform": "xiaohongshu",
  "user_id": "5ff98b9d0000000001008f40",  // ä¸»é”®ï¼Œç”¨äºå…³è”
  "notes": [
    {
      "note_id": "xxx",
      "user_id": "5ff98b9d0000000001008f40",
      "title": "æ ‡é¢˜",
      "desc": "æè¿°",
      "likes": 123,
      "collected_count": 45,
      "comments_count": 67,
      "share_count": 8,
      "tag_list": ["æ ‡ç­¾"],
      "time": 1234567890,
      "note_url": "URL"
    }
  ],
  "total_notes": 20,
  "created_at": ISODate,
  "updated_at": ISODate
}
```
**ç´¢å¼•**: user_id, platform

---

### Collection 2: user_profiles (éœ€è¦é‡æ„)
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ + AIåˆ†æç»“æœ
**æ¥æº**: 
1. TikHub fetch_user_info_app (åŸºç¡€ä¿¡æ¯)
2. DeepSeek AI åˆ†æ (å†…å®¹åˆ†æ)
**ç»“æ„**:
```javascript
{
  "_id": ObjectId,
  "platform": "xiaohongshu",
  "user_id": "5ff98b9d0000000001008f40",  // ä¸»é”®ï¼Œå…³è”snapshots
  
  // === åŸºç¡€ä¿¡æ¯ (æ¥è‡ªfetch_user_info_app) ===
  "basic_info": {
    "nickname": "æ˜Ÿçƒç ”ç©¶æ‰€InstituteforPlanet",
    "red_id": "9421098264",
    "desc": "çƒ­çˆ±äººç±»ï¼Œçƒ­çˆ±åœ°çƒã€‚",
    "avatar": "https://...",
    "gender": 2,  // 0: æœªçŸ¥, 1: ç”·, 2: å¥³
    "ip_location": "åŒ—äº¬"
  },
  
  // === äº’åŠ¨æ•°æ® (æ¥è‡ªfetch_user_info_app) ===
  "stats": {
    "fans": 1087876,        // âœ… ç²‰ä¸æ•°
    "follows": 40,          // å…³æ³¨æ•°
    "total_liked": 2779558, // æ€»è·èµæ•°
    "total_collected": 881366, // æ€»è¢«æ”¶è—æ•°
    "note_count": 195       // ç¬”è®°æ•°
  },
  
  // === æ ‡ç­¾ (æ¥è‡ªfetch_user_info_app) ===
  "tags": ["20æ¡åŸåˆ›å†…å®¹"],
  
  // === AIåˆ†æå†…å®¹ (æ¥è‡ªDeepSeek + snapshots) ===
  "profile_data": {
    "content_topics": [
      "ä¸­å›½åœ°ç†ä¸è‡ªç„¶æ™¯è§‚",
      "ç§‘æŠ€å·¥ç¨‹ä¸åŸºå»ºæˆå°±",
      "å†å²æ–‡åŒ–ä¸æ–‡æ˜æ¢ç´¢"
    ],
    "content_style": [
      "ç§‘æ™®å‘", "é•¿æ–‡å›¾æ–‡", "é«˜è´¨é‡åŸåˆ›"
    ],
    "user_style": {
      "persona": "åœ°ç†ç§‘æ™®åšä¸»",
      "tone": "ä¸“ä¸šã€ä¸¥è°¨ã€éœ‡æ’¼",
      "interests": ["åœ°ç†", "å†å²", "ç§‘æŠ€"]
    }
  },
  
  "created_at": ISODate,
  "updated_at": ISODate,
  "synced_from_api_at": ISODate  // æœ€åä¸€æ¬¡ä»APIåŒæ­¥çš„æ—¶é—´
}
```
**ç´¢å¼•**: user_id, platform

---

### Collection 3: user_embeddings (éœ€è¦ä¿®å¤)
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·é£æ ¼çš„å‘é‡è¡¨ç¤º
**æ¥æº**: æœ¬åœ°BAAI/bge-small-zh-v1.5æ¨¡å‹
**ç»“æ„**:
```javascript
{
  "_id": ObjectId,
  "platform": "xiaohongshu",
  "user_id": "5ff98b9d0000000001008f40",  // âš ï¸ ä¿®å¤: åº”è¯¥æ˜¯user_idè€Œä¸æ˜¯nickname
  "embedding": [0.123, -0.456, ...],  // 512ç»´å‘é‡
  "model": "BAAI/bge-small-zh-v1.5",
  "dimension": 512,
  "created_at": ISODate
}
```
**ç´¢å¼•**: user_id, platform
**ä¿®å¤**: å½“å‰å­˜çš„æ˜¯nicknameï¼Œéœ€è¦æ”¹ä¸ºuser_id

---

### Collection 4: creator_networks (éœ€è¦ä¼˜åŒ–)
**ç”¨é€”**: åˆ›ä½œè€…ç½‘ç»œå›¾æ•°æ®
**æ¥æº**: 
1. user_profiles (åŸºç¡€ä¿¡æ¯ + ç²‰ä¸æ•°)
2. user_embeddings (ç›¸ä¼¼åº¦è®¡ç®—)
**ç»“æ„**:
```javascript
{
  "_id": ObjectId,
  "platform": "xiaohongshu",
  "network_data": {
    "creators": [
      {
        "id": "5ff98b9d0000000001008f40",  // user_id
        "name": "æ˜Ÿçƒç ”ç©¶æ‰€InstituteforPlanet",
        "followers": 1087876,  // âœ… ä»user_profiles.stats.fansè·å–
        "engagementIndex": 453030,  // ä»snapshotsè®¡ç®—
        "primaryTrack": "ä¸­å›½åœ°ç†ä¸è‡ªç„¶æ™¯è§‚",
        "contentForm": "ç§‘æ™®å‘, é•¿æ–‡å›¾æ–‡",
        "topics": ["åœ°ç†", "å†å²", "ç§‘æŠ€"],
        "avatar": "https://...",
        "ipLocation": "åŒ—äº¬",
        "desc": "ç®€ä»‹",
        "redId": "9421098264",
        "position": {"x": 100, "y": 200}
      }
    ],
    "edges": [
      {
        "source": "user_id_1",
        "target": "user_id_2",
        "weight": 0.803,  // embeddingä½™å¼¦ç›¸ä¼¼åº¦
        "types": {
          "keyword": 0.803,
          "audience": 0,
          "style": 0,
          "campaign": 0
        }
      }
    ]
  },
  "created_at": ISODate
}
```
**ç´¢å¼•**: platform

---

## ğŸ”„ æ•°æ®æµç¨‹è®¾è®¡

### é˜¶æ®µ1: åˆå§‹æ•°æ®é‡‡é›†
```
1. è°ƒç”¨ get_user_notes_v2
   â””â”€> ä¿å­˜åˆ° user_snapshots
   
2. è°ƒç”¨ fetch_user_info_app (æ–°å¢)
   â””â”€> ä¿å­˜åˆ° user_profiles.basic_info + stats
   
3. AIåˆ†æ (ä½¿ç”¨snapshotsä¸­çš„notes)
   â””â”€> ä¿å­˜åˆ° user_profiles.profile_data
   
4. ç”Ÿæˆembedding (ä½¿ç”¨profile_data)
   â””â”€> ä¿å­˜åˆ° user_embeddings
```

### é˜¶æ®µ2: ç”Ÿæˆåˆ›ä½œè€…ç½‘ç»œ
```
regenerate_creator_networks.py:
  1. ä» user_snapshots è¯»å–æ‰€æœ‰user_id
  2. ä» user_profiles è·å–:
     - basic_info (nickname, avatar, descç­‰)
     - stats.fans (ç²‰ä¸æ•°) âœ…
     - profile_data (topics, styleç­‰)
  3. ä» snapshots è®¡ç®— engagementIndex
  4. ä» user_embeddings è®¡ç®—ç›¸ä¼¼åº¦
  5. ç”Ÿæˆ creator_networks
```

### é˜¶æ®µ3: æ•°æ®æ›´æ–°
```
å®šæœŸæ›´æ–°æµç¨‹:
  1. get_user_notes_v2 â†’ æ›´æ–° user_snapshots (æ¯å‘¨)
  2. fetch_user_info_app â†’ æ›´æ–° user_profiles.stats (æ¯å¤©)
  3. é‡æ–°ç”Ÿæˆ creator_networks (æŒ‰éœ€)
```

---

## ğŸ› ï¸ éœ€è¦ä¿®å¤çš„è„šæœ¬

### 1. collector.py (éœ€è¦å¢å¼º)
**ä¿®æ”¹**:
```python
def fetch_user_full_data(user_id: str) -> dict:
    """è·å–ç”¨æˆ·å®Œæ•´æ•°æ®"""
    # 1. è·å–ç¬”è®°
    notes_data = fetch_user_notes(user_id)  # ç°æœ‰é€»è¾‘
    
    # 2. è·å–ç”¨æˆ·ä¿¡æ¯ (æ–°å¢)
    user_info = fetch_user_info(user_id)
    
    return {
        'user_id': user_id,
        'notes': notes_data['notes'],
        'user_info': user_info
    }

def fetch_user_info(user_id: str) -> dict:
    """è°ƒç”¨fetch_user_info_app API"""
    url = 'https://api.tikhub.io/api/v1/xiaohongshu/web_v2/fetch_user_info_app'
    response = requests.get(url, params={'user_id': user_id}, headers=headers)
    data = response.json()['data']
    
    return {
        'basic_info': {
            'nickname': data['nickname'],
            'red_id': data['red_id'],
            'desc': data['desc'],
            'avatar': data['images'],
            'gender': data['gender'],
            'ip_location': data['ip_location']
        },
        'stats': {
            'fans': data['fans'],
            'follows': data['follows'],
            'total_liked': data['liked'],
            'total_collected': data['collected'],
            'note_count': data.get('collected_notes_num', 0)
        },
        'tags': data.get('tags', [])
    }

def save_to_mongodb(user_id: str, data: dict):
    """ä¿å­˜åˆ°MongoDB"""
    # 1. ä¿å­˜snapshots
    snapshot_repo.create_snapshot({
        'platform': 'xiaohongshu',
        'user_id': user_id,
        'notes': data['notes'],
        'total_notes': len(data['notes'])
    })
    
    # 2. ä¿å­˜æˆ–æ›´æ–°profile (æ–°å¢)
    profile_repo.upsert_profile({
        'platform': 'xiaohongshu',
        'user_id': user_id,
        'basic_info': data['user_info']['basic_info'],
        'stats': data['user_info']['stats'],
        'tags': data['user_info']['tags'],
        'synced_from_api_at': datetime.now()
    })
```

### 2. regenerate_creator_networks.py (éœ€è¦ä¼˜åŒ–)
**ä¿®æ”¹**:
```python
# ä»profileè·å–å®Œæ•´ä¿¡æ¯
profile = profile_repo.get_by_user_id(user_id)
if profile:
    basic_info = profile.get('basic_info', {})
    stats = profile.get('stats', {})
    
    nickname = basic_info.get('nickname', 'Unknown')
    followers = stats.get('fans', 0)  # âœ… çœŸå®ç²‰ä¸æ•°
    avatar = basic_info.get('avatar', '')
    ip_location = basic_info.get('ip_location', '')
    desc = basic_info.get('desc', '')
```

### 3. ä¿®å¤user_embeddingsçš„user_id
**è„šæœ¬**: `fix_embeddings_user_id.py`
```python
# å°†user_embeddingsä¸­çš„nicknameæ”¹ä¸ºuser_id
embeddings = embeddings_collection.find({})
for emb in embeddings:
    nickname = emb['user_id']
    # ä»profilesæ‰¾åˆ°å¯¹åº”çš„user_id
    profile = profiles_collection.find_one({'nickname': nickname})
    if profile and profile.get('user_id'):
        embeddings_collection.update_one(
            {'_id': emb['_id']},
            {'$set': {'user_id': profile['user_id']}}
        )
```

---

## ğŸ“ æ€»ç»“

### å…³é”®æ”¹è¿›
1. âœ… **ç²‰ä¸æ•°é—®é¢˜è§£å†³**: ä½¿ç”¨fetch_user_info_appè·å–çœŸå®ç²‰ä¸æ•°
2. âœ… **æ•°æ®å…³è”**: ç»Ÿä¸€ä½¿ç”¨user_idä½œä¸ºä¸»é”®
3. âœ… **æ•°æ®åˆ†å±‚**: 
   - snapshots (ç¬”è®°æ•°æ®ï¼Œé«˜é¢‘æ›´æ–°)
   - profiles (ç”¨æˆ·ä¿¡æ¯ï¼Œä½é¢‘æ›´æ–°)
   - embeddings (å‘é‡ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆ)
   - networks (ç½‘ç»œå›¾ï¼ŒæŒ‰éœ€ç”Ÿæˆ)
4. âœ… **ç›¸ä¼¼åº¦è®¡ç®—**: ä½¿ç”¨embeddingä½™å¼¦ç›¸ä¼¼åº¦

### éœ€è¦æ‰§è¡Œçš„æ­¥éª¤
1. ä¸ºæ‰€æœ‰9ä¸ªç”¨æˆ·è°ƒç”¨fetch_user_info_appï¼Œæ›´æ–°profiles
2. ä¿®å¤user_embeddingsä¸­çš„user_id
3. é‡æ–°è¿è¡Œregenerate_creator_networks.py
4. å‰ç«¯å°†æ˜¾ç¤ºçœŸå®çš„ç²‰ä¸æ•°å’Œæ›´ä¸°å¯Œçš„ç½‘ç»œè¿æ¥
